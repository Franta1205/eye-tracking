<div class="min-h-screen bg-gray-50 py-12">
  <div class="sm:mx-auto sm:w-full sm:max-w-2xl">
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 px-8 py-10">
      <h2 class="text-2xl font-bold text-gray-900 mb-8">Create New Analysis</h2>
      
      <%= form_with(model: @analysis, local: true, html: { class: "space-y-6", id: "new_analysis" }) do |form| %>
        <% if @analysis.errors.any? %>
          <div class="rounded-lg bg-red-50 p-4 border border-red-200">
            <h3 class="text-sm font-medium text-red-800">Please fix the following errors:</h3>
            <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
              <% @analysis.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div>
          <%= form.label :name, class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_field :name,
              class: "block w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-gray-900 focus:ring-1 focus:ring-gray-900 transition-colors",
              placeholder: "Enter analysis name",
              required: true %>
        </div>

        <div>
          <%= form.label :analysis_type, class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.select :analysis_type, Analysis.analysis_types.map {|key, value| [key.humanize, key]}, { selected: "general_design", include_blank: false }, { class: "block w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-gray-900 focus:ring-1 focus:ring-gray-900 transition-colors" } %>
        </div>

        <div>
          <%= form.label :participants, "Number of Participants", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <div class="relative">
            <!-- Hidden input field for form submission -->
            <%= form.hidden_field :participants, value: 1, required: true %>

            <!-- Custom slider interface -->
            <div id="participant-slider-container" class="bg-gray-50 rounded-lg p-6 border border-gray-200">
              <div class="flex items-center justify-between mb-4">
                <span class="text-sm text-gray-600">Drag to select:</span>
                <span id="participant-count" class="text-lg font-semibold text-gray-900">1 participant</span>
              </div>

              <div class="relative">
                <!-- Slider track -->
                <div id="slider-track" class="w-full h-2 bg-gray-200 rounded-full relative">
                  <div id="slider-fill" class="h-2 bg-gray-900 rounded-full transition-all duration-75" style="width: 0%"></div>
                </div>

                <!-- Slider handle -->
                <div id="slider-handle"
                     class="absolute top-1/2 transform -translate-y-1/2 -translate-x-1/2 w-6 h-6 bg-white border-2 border-gray-900 rounded-full cursor-grab active:cursor-grabbing shadow-sm hover:shadow-md transition-shadow duration-75"
                     style="left: 0%">
                </div>
              </div>

              <!-- Range indicators -->
              <div class="flex justify-between mt-2 text-xs text-gray-500">
                <span>1</span>
                <span>15</span>
                <span>30</span>
              </div>
            </div>
          </div>
        </div>

        <div>
          <%= form.label :image, "Upload Image", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
            <%= form.file_field :image,
                class: "hidden",
                id: "image-upload",
                accept: "image/*",
                required: true %>
            <label for="image-upload" class="cursor-pointer">
              <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <p class="mt-2 text-sm text-gray-600">Click to upload or drag and drop</p>
              <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
            </label>
          </div>
        </div>

        <div>
          <%= form.label :goals, "Analysis Goals", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_area :goals, 
              rows: 4,
              class: "block w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-gray-900 focus:ring-1 focus:ring-gray-900 transition-colors",
              placeholder: "Describe the goals of this analysis..." %>
        </div>

        <div class="pt-4">
          <%= form.submit "Create Analysis",
              class: "w-full flex justify-center py-3 px-4 rounded-lg text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 transition-colors cursor-pointer",
              id: "submit-button",
              data: { disable_with: "Creating Analysis..." } %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Preview uploaded image
  document.getElementById('image-upload').addEventListener('change', function(e) {
    const fileName = e.target.files[0]?.name;
    if (fileName) {
      const label = e.target.nextElementSibling;
      label.querySelector('p').textContent = fileName;
    }
  });

  // Participant slider functionality
  document.addEventListener('DOMContentLoaded', function() {
    const sliderContainer = document.getElementById('participant-slider-container');
    const sliderTrack = document.getElementById('slider-track');
    const sliderHandle = document.getElementById('slider-handle');
    const sliderFill = document.getElementById('slider-fill');
    const participantCount = document.getElementById('participant-count');
    const participantsInput = document.getElementById('analysis_participants');

    let isDragging = false;
    let sliderRect;

    const minParticipants = 1;
    const maxParticipants = 30;

    function updateSlider(percentage, disableTransitions = false) {
      // Ensure percentage is between 0 and 100
      percentage = Math.max(0, Math.min(100, percentage));

      // Calculate participant count (1-30)
      const participants = Math.round(minParticipants + (percentage / 100) * (maxParticipants - minParticipants));

      // Disable transitions during drag for smoother performance
      if (disableTransitions) {
        sliderFill.style.transition = 'none';
      } else {
        sliderFill.style.transition = '';
      }

      // Update UI
      sliderHandle.style.left = percentage + '%';
      sliderFill.style.width = percentage + '%';
      participantCount.textContent = participants + (participants === 1 ? ' participant' : ' participants');

      // Update hidden input
      participantsInput.value = participants;
    }

    function getPercentageFromMouseX(mouseX) {
      if (!sliderRect) return 0;
      const relativeX = mouseX - sliderRect.left;
      return (relativeX / sliderRect.width) * 100;
    }

    // Mouse events
    sliderHandle.addEventListener('mousedown', function(e) {
      isDragging = true;
      sliderRect = sliderTrack.getBoundingClientRect();
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
      e.preventDefault();
    });

    function handleMouseMove(e) {
      if (isDragging) {
        const percentage = getPercentageFromMouseX(e.clientX);
        updateSlider(percentage, true);
      }
    }

    function handleMouseUp() {
      isDragging = false;
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    }

    // Click on track to jump to position
    sliderTrack.addEventListener('click', function(e) {
      sliderRect = this.getBoundingClientRect();
      const percentage = getPercentageFromMouseX(e.clientX);
      updateSlider(percentage);
    });

    // Touch events for mobile
    sliderHandle.addEventListener('touchstart', function(e) {
      isDragging = true;
      sliderRect = sliderTrack.getBoundingClientRect();
      document.addEventListener('touchmove', handleTouchMove, { passive: false });
      document.addEventListener('touchend', handleTouchEnd);
      e.preventDefault();
    });

    function handleTouchMove(e) {
      if (isDragging && e.touches[0]) {
        const percentage = getPercentageFromMouseX(e.touches[0].clientX);
        updateSlider(percentage, true);
        e.preventDefault();
      }
    }

    function handleTouchEnd() {
      isDragging = false;
      document.removeEventListener('touchmove', handleTouchMove);
      document.removeEventListener('touchend', handleTouchEnd);
    }

    // Initialize slider to minimum value
    updateSlider(0);
  });

  // Loading spinner
  const form = document.getElementById('new_analysis');
  if (form) {
    form.addEventListener('submit', function(e) {
      // Check if image is selected
      const imageInput = document.getElementById('image-upload');
      if (!imageInput || !imageInput.files[0]) {
        return; // Don't show spinner if no image selected
      }

      // Show loading overlay
      const loadingOverlay = document.createElement('div');
      loadingOverlay.id = 'loading-overlay';
      loadingOverlay.className = 'fixed inset-0 flex items-center justify-center z-50';
      loadingOverlay.innerHTML = `
        <div class="bg-gray-900 rounded-xl shadow-2xl p-8 max-w-sm mx-4 text-center border border-gray-700">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
          <h3 class="text-lg font-medium text-white mb-2">Processing Image</h3>
          <p class="text-sm text-gray-300">Analyzing your image with AI saliency detection...</p>
          <p class="text-xs text-gray-400 mt-2">This may take 30-60 seconds</p>
        </div>
      `;
      document.body.appendChild(loadingOverlay);
    });
  }
</script>